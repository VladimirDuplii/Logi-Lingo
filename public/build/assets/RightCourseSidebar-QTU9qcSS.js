import{r,j as e}from"./app-CB6H9fcf.js";import{C as N}from"./DuoLayout-1S1Fd3QP.js";import{u as te,P as w}from"./Toast-BdGrl3Cx.js";const k=({title:d,children:h})=>e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-4 shadow-sm",children:[e.jsx("h3",{className:"mb-3 text-sm font-bold uppercase text-gray-500",children:d}),h]});function le({course:d,hearts:h,points:A,otherCourses:o=[]}){const E=te(),x=d?.id,[X,M]=r.useState(!1),[_,C]=r.useState([]),[f,L]=r.useState(x||null),[n,u]=r.useState(null),D=r.useRef(null);r.useEffect(()=>{const t=a=>{if(!n)return;const l=D.current;l&&!l.contains(a.target)&&u(null)},s=a=>{n&&a.key==="Escape"&&u(null)};return document.addEventListener("mousedown",t),document.addEventListener("keydown",s),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("keydown",s)}},[n]);const[P,p]=r.useState(!0),[Q,b]=r.useState(""),[j,$]=r.useState([]),[i,T]=r.useState({points:A,hearts:h,date:"",daily_goal_xp:30,gems:0,streak:0}),m=r.useMemo(()=>(Array.isArray(o)?o:[]).filter(s=>s&&s.id!==x),[o,x]);r.useEffect(()=>{let t=!0;return(async()=>{try{p(!0),b("");const s=await w.getDailyQuests(),a=s?.data||s,l=Array.isArray(a?.quests)?a.quests:[];t&&($(l),T({points:a?.points??A,hearts:a?.hearts??h,date:a?.date||"",daily_goal_xp:a?.daily_goal_xp??30,gems:a?.gems??0,streak:a?.streak??0}))}catch{t&&b("Не вдалося завантажити квести.")}finally{t&&p(!1)}})(),()=>{t=!1}},[x]);const z=async()=>{try{p(!0),b("");const t=await w.getDailyQuests(),s=t?.data||t;$(Array.isArray(s?.quests)?s.quests:[]),T({points:s?.points??A,hearts:s?.hearts??h,date:s?.date||"",daily_goal_xp:s?.daily_goal_xp??i.daily_goal_xp,gems:s?.gems??i.gems,streak:s?.streak??i.streak})}catch{b("Не вдалося оновити квести.")}finally{p(!1)}};r.useEffect(()=>{let t=!0;return(async()=>{if(m.length>0){C([]);return}try{M(!0);const s=await N.getStartedCourses?.()?.catch(()=>N.getCourses())||await N.getCourses(),l=(Array.isArray(s?.data?.courses)?s.data.courses:Array.isArray(s?.courses)?s.courses:Array.isArray(s?.data?.data)?s.data.data:Array.isArray(s?.data)?s.data:Array.isArray(s)?s:[]).filter(O=>O&&O.id!==x),g=s?.data?.activeCourseId??s?.activeCourseId??null;t&&(C(l),g&&L(g))}catch{t&&C([])}finally{t&&M(!1)}})(),()=>{t=!1}},[m.length,x]);const F=m.length>0?m:_,v=r.useMemo(()=>j.find(t=>t.key==="xp_30"),[j]),S=r.useMemo(()=>{const t=Array.isArray(o)?o:[],s=m.length>0?t:_.concat(d?[d]:[]),a=new Set;return s.filter(l=>!l||!l.id||a.has(l.id)?!1:(a.add(l.id),!0))},[o,_,m.length,d]),U=r.useMemo(()=>d&&d.id?d:S.find(t=>t.id===f)||null,[d,S,f]),Y=async t=>{try{await N.setActiveCourse(t),L(t),u(null),E.success("Active course updated")}catch{E.error("Не вдалося змінити курс")}},c=new Date,B=c.toLocaleString("en-US",{month:"long"}),y=c.getFullYear(),K=new Date(y,c.getMonth(),1),V=new Date(y,c.getMonth()+1,0),W=Array.from({length:V.getDate()},(t,s)=>s+1),[H,I]=r.useState([]),[J,R]=r.useState(!0),[Z,q]=r.useState(""),[G,ee]=r.useState(null);return r.useEffect(()=>{let t=!0;return(async()=>{try{R(!0),q("");const s=await w.getMyLeague?.(),a=s?.data?.data||s?.data||s;t&&ee(a||null)}catch(s){t&&q(s?.response?.data?.message||"")}finally{t&&R(!1)}})(),()=>{t=!1}},[]),r.useEffect(()=>{n==="streak"&&(async()=>{try{const t=await w.getPracticeCalendar?.(c.getMonth()+1,y),s=t?.data||t,a=Array.isArray(s?.days)?s.days:[];I(a)}catch{I([])}})()},[n,y,c]),e.jsxs("aside",{className:"flex w-full flex-col gap-4",children:[e.jsxs("div",{ref:D,className:"my-1 flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",className:"relative flex cursor-pointer items-center gap-2 rounded-xl p-2 font-bold uppercase text-gray-600 hover:bg-gray-100","aria-expanded":n==="course",onClick:()=>u(t=>t==="course"?null:"course"),children:[e.jsx("div",{className:"h-6 w-8 rounded bg-gray-200","aria-hidden":!0}),e.jsx("div",{children:U?.title||"Course"})]}),n==="course"&&e.jsxs("div",{className:"absolute left-1/2 top-full z-10 w-72 -translate-x-1/2 overflow-hidden rounded-2xl border-2 border-gray-300 bg-white shadow-xl",children:[e.jsx("h2",{className:"px-5 py-3 text-sm font-bold uppercase text-gray-400",children:"My courses"}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:S.map(t=>e.jsxs("button",{onClick:()=>Y(t.id),className:`flex w-full items-center gap-3 border-t-2 border-gray-300 px-5 py-3 text-left text-sm font-bold ${t.id===f?"bg-blue-100 text-blue-600":"hover:bg-gray-50"}`,children:[e.jsx("div",{className:"h-6 w-8 rounded bg-gray-200","aria-hidden":!0}),e.jsx("span",{className:t.id===f?"text-blue-600":"text-gray-700",children:t.title})]},t.id))}),e.jsxs("a",{href:"/courses",className:"flex w-full items-center gap-3 rounded-b-2xl border-t-2 border-gray-300 px-5 py-3 text-left text-sm font-bold hover:bg-gray-100",children:[e.jsx("span",{className:"flex h-6 w-6 items-center justify-center rounded-lg border-2 border-gray-400 text-lg font-bold text-gray-400",children:"+"}),e.jsx("span",{className:"text-gray-600",children:"Add new course"})]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",className:"relative flex items-center gap-2 rounded-xl p-2 font-bold text-orange-500 hover:bg-gray-100","aria-expanded":n==="streak",onClick:()=>u(t=>t==="streak"?null:"streak"),children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none",children:"🔥"}),e.jsx("span",{className:"text-gray-400",children:i.streak||0})]}),n==="streak"&&e.jsxs("div",{className:"absolute left-1/2 top-full z-10 w-96 -translate-x-1/2 rounded-2xl border-2 border-gray-300 bg-white p-5 text-black shadow-xl",children:[e.jsx("h2",{className:"text-center text-lg font-bold",children:"Streak"}),e.jsx("p",{className:"text-center text-sm font-normal text-gray-400",children:"Practice daily to keep your streak growing."}),e.jsxs("article",{className:"mt-3 rounded-xl border-2 border-gray-300 p-3 text-gray-600",children:[e.jsx("header",{className:"mb-2 flex items-center justify-between gap-3",children:e.jsxs("div",{className:"text-lg font-bold uppercase text-gray-500",children:[B," ",y]})}),e.jsx("div",{className:"grid grid-cols-7 gap-1 px-1 py-2 text-center text-xs text-gray-500",children:["S","M","T","W","T","F","S"].map(t=>e.jsx("div",{className:"h-6 leading-6",children:t},t))}),e.jsxs("div",{className:"grid grid-cols-7 gap-1 px-1 py-2 text-center text-sm",children:[Array.from({length:K.getDay()}).map((t,s)=>e.jsx("div",{className:"h-8"},`pad-${s}`)),W.map(t=>{const s=t===c.getDate(),l=H.includes(t)?"bg-green-500 text-white":s?"bg-gray-300 text-gray-700":"text-gray-700";return e.jsx("div",{className:`flex h-8 w-8 items-center justify-center rounded-full mx-auto ${l}`,children:t},t)})]})]})]})]}),e.jsxs("div",{className:"relative flex items-center gap-2 rounded-xl p-2 font-bold text-red-500 hover:bg-gray-100",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-2","aria-expanded":n==="gems",onClick:()=>u(t=>t==="gems"?null:"gems"),children:[e.jsx("span",{"aria-hidden":!0,children:"💎"}),e.jsx("span",{className:"text-gray-400",children:i.gems||0})]}),n==="gems"&&e.jsx("div",{className:"absolute left-1/2 top-full z-10 w-72 -translate-x-1/2 items-center gap-3 rounded-2xl border-2 border-gray-300 bg-white p-5 shadow-xl",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("h2",{className:"text-xl font-bold text-black",children:"Gems"}),e.jsxs("p",{className:"text-sm font-normal text-gray-400",children:["You have ",i.gems||0," gems."]}),e.jsx("a",{className:"uppercase text-blue-500 transition hover:brightness-110",href:"/shop",children:"Go to shop →"})]})})]})]}),e.jsx(k,{title:"Daily Quests",children:P?e.jsx("ul",{className:"space-y-2 animate-pulse",children:[1,2,3].map(t=>e.jsxs("li",{className:"rounded-lg border border-gray-100 p-3",children:[e.jsx("div",{className:"mb-2 h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-2 w-full rounded bg-gray-200"}),e.jsx("div",{className:"mt-1 h-3 w-10 rounded bg-gray-200 ml-auto"})]},t))}):Q?e.jsxs("div",{className:"flex items-center justify-between text-sm text-red-600",children:[e.jsx("span",{children:Q}),e.jsx("button",{onClick:z,className:"rounded border px-2 py-1 text-xs text-red-700 hover:bg-red-50",children:"Спробувати знову"})]}):j.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"No quests for today."}):e.jsxs(e.Fragment,{children:[e.jsx("ul",{className:"space-y-2",children:j.map(t=>{const s=Number(t.progress||0),a=Math.max(1,Number(t.total||0)),l=Math.min(100,Math.round(s/a*100)),g=!!t.completed;return e.jsxs("li",{className:`rounded-lg border p-3 ${g?"border-green-200 bg-green-50":"border-gray-100"}`,children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium text-gray-800",children:t.title}),g&&e.jsx("span",{className:"text-xs font-semibold text-green-600",children:"✓"})]}),e.jsx("div",{className:"h-2 w-full rounded bg-gray-200",children:e.jsx("div",{className:`h-2 rounded ${g?"bg-green-600":"bg-green-500"}`,style:{width:`${l}%`}})}),e.jsxs("div",{className:"mt-1 text-right text-xs text-gray-500",children:[s,"/",a]})]},t.key)})}),e.jsxs("div",{className:"mt-2 flex items-center justify-between text-xs text-gray-400",children:[e.jsxs("span",{children:["Сьогодні: ",i?.date||""]}),e.jsx("button",{onClick:z,className:"rounded border px-2 py-1 text-xs text-gray-600 hover:bg-gray-50",children:"Оновити"})]})]})}),e.jsxs(k,{title:"Daily Goal",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:["Earn ",i?.daily_goal_xp||30," XP today"]}),e.jsx("a",{href:"/settings/coach",className:"text-xs text-blue-600 hover:text-blue-700",children:"Edit Goal"})]}),e.jsx("div",{className:"mt-2 h-2 w-full rounded bg-gray-200",children:P?e.jsx("div",{className:"h-2 w-1/3 rounded bg-blue-200 animate-pulse"}):e.jsx("div",{className:"h-2 rounded bg-blue-500",style:{width:`${Math.min(100,Math.round((v?.progress||0)/Math.max(1,i?.daily_goal_xp||v?.total||30)*100))}%`}})}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:[v?.progress||0,"/",i?.daily_goal_xp||v?.total||30," XP"]})]}),e.jsx(k,{title:"League",children:J?e.jsx("div",{className:"h-6 w-40 animate-pulse rounded bg-gray-200"}):Z?e.jsx("div",{className:"text-sm text-gray-500",children:"Leagues initializing…"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:G?.current?.tier?.name||"Unranked"}),e.jsx("div",{className:"text-xs text-gray-500",children:"This week"})]}),e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:[G?.this_week?.xp??0," XP"]})]}),e.jsx("a",{href:"/leaderboard",className:"mt-2 inline-block text-xs font-semibold text-blue-600 hover:text-blue-700",children:"View leaderboard →"})]})}),e.jsx(k,{title:"Other Courses",children:X?e.jsx("ul",{className:"space-y-2 animate-pulse",children:[1,2,3].map(t=>e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-md bg-gray-200"}),e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"})]}),e.jsx("div",{className:"h-4 w-12 rounded bg-gray-200"})]},t))}):F.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"No other courses"}):e.jsx("ul",{className:"space-y-2",children:F.slice(0,6).map(t=>e.jsx("li",{children:e.jsxs("a",{href:`/courses/${t.id}`,className:"group flex items-center justify-between rounded-lg border border-gray-100 p-3 transition hover:bg-gray-50 hover:shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-200",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.title,className:"h-8 w-8 rounded-md object-cover ring-1 ring-gray-200",loading:"lazy",onError:s=>{s.currentTarget.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><rect width='100%' height='100%' fill='%23e5e7eb'/></svg>"}}):e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-gray-100 text-sm font-semibold text-gray-500 ring-1 ring-gray-200",children:t.title?.charAt(0)||"C"}),e.jsx("span",{className:"truncate text-sm font-medium text-gray-800",children:t.title})]}),e.jsx("span",{className:"text-xs font-semibold text-blue-600 group-hover:text-blue-700",children:"Open →"})]})},t.id))})})]})}export{le as R};
