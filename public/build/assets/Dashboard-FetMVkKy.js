import{r,s as le,j as e,H as O,L as N}from"./app-CB6H9fcf.js";import"./Dropdown-aLMiQvGl.js";import{u as ne,P as y}from"./Toast-BdGrl3Cx.js";import{C as ie,D as z}from"./DuoLayout-1S1Fd3QP.js";import{C as o}from"./card-Cn0cBMnd.js";import{B as I}from"./button-2bCJMJSP.js";import{H as T,C as ce}from"./CourseCard-Bgn6y8EQ.js";import{P as oe}from"./ProgressBar-BOgo5wNz.js";import{S as i,C as de}from"./Skeleton-C7VVEt2j.js";import{C as me}from"./CourseProgress-Bjfzoz6t.js";import"./transition-B2x3TEpM.js";function we({auth:v}){const E=ne(),[w,G]=r.useState([]),[C,K]=r.useState([]),[Q,R]=r.useState(!0),[k,q]=r.useState(null),[H,V]=r.useState(null),[m,M]=r.useState(null),[h,P]=r.useState(null),[U,S]=r.useState([]),[p,W]=r.useState(!1),_=!!v?.user;r.useEffect(()=>{const s=setTimeout(()=>W(!0),0);return()=>clearTimeout(s)},[]),r.useEffect(()=>{if(!_){q("Будь ласка, увійдіть в систему для перегляду дашборду."),R(!1);return}let s=!1;const t=a=>{typeof performance<"u"&&performance.mark(a)},L=(a,f,x)=>{if(typeof performance<"u")try{performance.measure(a,f,x)}catch{}};return(async()=>{t("dash-start");try{try{le(null)}catch{}const f=await y.getUserProgress(),x=f?.data||f?.userProgress||null;if(s)return;M(x);const $=x?.active_course_id||x?.activeCourse?.id,g=[];$?g.push(y.getCourseProgress($).then(c=>{if(s)return;const j=c?.data||[],l=j.reduce((n,u)=>{const d=Array.isArray(u?.lessons)?u.lessons:[];return n.total+=d.length,n.completed+=d.filter(b=>!!b?.completed).length,n},{total:0,completed:0}),D=l.total?Math.round(l.completed/l.total*100):0;P({totalLessons:l.total,completedLessons:l.completed,percent:D});const te=j.map(n=>{const u=Array.isArray(n?.lessons)?n.lessons:[],d=u.length,b=u.filter(re=>!!re?.completed).length,ae=d?Math.round(b/d*100):0;return{id:n.id,title:n.title||`Розділ ${n.order??""}`.trim(),completed:b,total:d,percent:ae}});S(te)}).catch(()=>{s||(P({totalLessons:0,completedLessons:0,percent:0}),S([]))})):(P({totalLessons:0,completedLessons:0,percent:0}),S([])),g.push(ie.getCourses().then(c=>{s||c?.data?.courses&&G(c.data.courses.slice(0,3))})),g.push(y.getAllCoursesProgress().then(c=>{if(!s&&c?.data?.data){const j=c.data.data.filter(l=>(l.completion_percentage||0)>0&&(l.completion_percentage||0)<100).sort((l,D)=>(D.last_activity_date||0)-(l.last_activity_date||0));K(j)}})),await Promise.allSettled(g)}catch(a){if(s)return;q("Failed to load dashboard data. Please try again later."),V({message:a?.message,stack:a?.stack,response:a?.response?{status:a.response.status,statusText:a.response.statusText,data:a.response.data}:"No response data",request:a?.request?"Request was made but no response received":"No request made"})}finally{s||(R(!1),t("dash-end"),L("dashboard-total","dash-start","dash-end"))}})(),()=>{s=!0}},[_]);const X=s=>{window.location.href=`/courses/${s.id}`},Y=()=>{const s=m?.active_course_id||m?.activeCourse?.id;if(s){window.location.href=`/courses/${s}?start=1`;return}window.location.href="/courses"},[A,B]=r.useState(!1),Z=async()=>{try{B(!0);const s=await y.refillHearts(),t=s?.data||s;t&&(M(L=>({...L||{},...t})),E?.success?.("Життя відновлено!"))}catch(s){const t=s?.response?.data?.message||"Не вдалося відновити життя";E?.error?.(t)}finally{B(!1)}},F=Math.max(0,Math.min(5,Number(m?.hearts||0))),J=Number(m?.points||0),ee=F<5&&J>=50,se=m?.activeCourse?.title||"Почнімо навчання";return _?e.jsxs(z,{children:[e.jsx(O,{title:"Dashboard"}),e.jsx("div",{className:"py-8 lg:py-10",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:Q?e.jsxs("div",{className:"space-y-8","aria-busy":"true","aria-label":"Завантаження дашборду",children:[e.jsx(o,{className:"p-6 md:p-8",children:e.jsxs("div",{className:"flex items-center gap-5",children:[e.jsx(i,{className:"h-14 w-14 rounded-2xl"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(i,{className:"h-5 w-48 mb-2"}),e.jsx(i,{className:"h-3 w-64"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(i,{className:"h-7 w-20 rounded-full"}),e.jsx(i,{className:"h-7 w-28 rounded-full"})]})]})}),e.jsxs(o,{className:"p-6 md:p-8",children:[e.jsx(i,{className:"h-4 w-24 mb-4"}),e.jsx(i,{className:"h-5 w-80 mb-4"}),e.jsx(i,{className:"h-2 w-full mb-2"}),e.jsx(i,{className:"h-2 w-2/3"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6",children:[...Array(3)].map((s,t)=>e.jsx(de,{},t))})]}):k?e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative",role:"alert",children:[e.jsx("strong",{className:"font-bold",children:"Error!"}),e.jsxs("span",{className:"block sm:inline",children:[" ",k]}),H&&e.jsxs("div",{className:"mt-4 p-4 bg-gray-100 rounded overflow-auto max-h-60",children:[e.jsx("h4",{className:"font-bold mb-2",children:"Debug Information:"}),e.jsx("pre",{className:"text-xs",children:JSON.stringify(H,null,2)})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(o,{id:"dash-header",className:`mb-8 overflow-hidden transition-all duration-500 ${p?"opacity-100 translate-y-0":"opacity-0 translate-y-2"}`,children:e.jsxs("div",{className:"p-6 md:p-8 flex flex-col md:flex-row md:items-center md:justify-between gap-8",children:[e.jsxs("div",{className:"flex items-center gap-5",children:[e.jsx("div",{className:"h-14 w-14 rounded-2xl bg-brand-gradient text-white text-xl font-bold flex items-center justify-center shadow-soft-lg",children:v?.user?.name?.charAt(0)||"U"}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-gradient-brand text-2xl font-bold tracking-tight",children:["Привіт, ",v.user.name]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Повернімося до навчання"})]})]}),e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"badge-pill brand",children:[e.jsx("span",{className:"text-sm",children:"⚡"}),e.jsx("span",{className:"text-sm font-semibold",children:J})]}),e.jsx("div",{className:"badge-pill accent",children:Array.from({length:5}).map((s,t)=>e.jsx("span",{className:`text-sm ${t<F?"opacity-100":"opacity-30"}`,children:"❤"},t))}),ee&&e.jsx(I,{onClick:Z,disabled:A,className:A?"opacity-70 cursor-not-allowed":"",children:A?"Виконується…":"Відновити життя -50 ⚡"})]})]})}),e.jsx(o,{id:"dash-continue",className:`mb-8 transition-all duration-500 delay-75 ${p?"opacity-100 translate-y-0":"opacity-0 translate-y-2"}`,children:e.jsxs("div",{className:"p-6 md:p-8 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-10",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-medium tracking-wide text-brand-600 mb-2 uppercase",children:"Активний курс"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 truncate",children:se}),e.jsxs("div",{className:"mt-4 w-full max-w-md",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 mb-1",children:[e.jsx("span",{children:"Прогрес"}),e.jsxs("span",{children:[h?.percent??0,"%"]})]}),e.jsx(oe,{value:h?.percent??0}),e.jsxs("div",{className:"mt-2 text-[11px] text-gray-500 tracking-wide",children:[h?.completedLessons??0," / ",h?.totalLessons??0," уроків завершено"]}),U?.length>0&&e.jsx("div",{className:"mt-4 flex flex-wrap gap-2",children:U.map(s=>e.jsxs("span",{className:`badge-pill ${s.percent===100?"brand":"accent"} !px-3 !py-1`,children:[e.jsx("span",{className:"truncate max-w-[7rem]",children:s.title}),e.jsxs("span",{className:"opacity-70",children:[s.percent,"%"]})]},s.id))})]})]}),e.jsxs("div",{className:"flex items-center gap-4 shrink-0",children:[e.jsx(I,{onClick:Y,children:"Продовжити"}),e.jsx(N,{href:"/courses",className:"relative inline-flex items-center gap-2 font-medium rounded-full border border-brand-300 hover:border-brand-400 bg-white text-brand-600 px-6 py-2 text-sm transition-colors",children:"Курси"})]})]})}),C.length>0&&e.jsx(o,{id:"dash-in-progress",className:`mb-8 transition-all duration-500 delay-100 ${p?"opacity-100 translate-y-0":"opacity-0 translate-y-2"}`,children:e.jsxs("div",{className:"p-6 md:p-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx(T,{level:3,children:"Продовжити навчання"}),e.jsx(N,{href:"/progress",className:"text-brand-600 hover:text-brand-700 text-sm font-medium",children:"Переглянути прогрес →"})]}),e.jsx("div",{className:"space-y-5",children:C.map(s=>e.jsx(me,{courseProgress:s},s.course_id))})]})}),w.length>0&&e.jsx(o,{id:"dash-recent",className:`transition-all duration-500 delay-150 ${p?"opacity-100 translate-y-0":"opacity-0 translate-y-2"}`,children:e.jsxs("div",{className:"p-6 md:p-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx(T,{level:3,children:"Нещодавні курси"}),e.jsx(N,{href:"/courses",className:"text-brand-600 hover:text-brand-700 text-sm font-medium",children:"Усі курси →"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6",children:w.map(s=>e.jsx(ce,{course:s,onClick:()=>X(s)},s.id))})]})}),C.length===0&&w.length===0&&e.jsxs(o,{className:"text-center py-16 mb-8",children:[e.jsx(T,{level:3,className:"mb-2",children:"Почнімо навчання"}),e.jsx("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"Обери курс і почни перший урок просто зараз."}),e.jsx(I,{onClick:()=>window.location.href="/courses",children:"Переглянути курси"})]})]})})})]}):e.jsxs(z,{children:[e.jsx(O,{title:"Dashboard"}),e.jsx("div",{className:"py-12",children:e.jsx("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative",role:"alert",children:[e.jsx("strong",{className:"font-bold",children:"Необхідна авторизація!"}),e.jsxs("span",{className:"block sm:inline",children:[" ",k]}),e.jsx("div",{className:"mt-4",children:e.jsx(N,{href:"/login",className:"inline-flex items-center px-4 py-2 bg-gray-800 border border-transparent rounded-md font-semibold text-xs text-white uppercase tracking-widest hover:bg-gray-700 focus:bg-gray-700 active:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition ease-in-out duration-150",children:"Увійти в систему"})})]})})})]})}export{we as default};
